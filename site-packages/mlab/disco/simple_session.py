"""A simple interface for SNMP sessions."""

import collections
# TODO(soltesz): replace netsnmp with easysnmp when available.
import netsnmp


class Error(Exception):
    """Base error class for simple_session module."""
    pass


class SNMPError(Error):
    """A netsnmp error occurred or no results returned."""
    pass


# TODO(soltesz): replace SNMPVariable with easysnmp.SNMPVariable when available.
class SNMPVariable(object):
    """An SNMP variable representing the result of a get or walk query.

    Attributes:
        oid: str, the OID of the variable.
        value: str, the OID value.
    """

    def __init__(self, oid, value):
        self.oid = oid
        self.value = value


class SimpleSession(object):
    """A simpler session interface for netsnmp.Session."""

    def __init__(self, session):
        """Creates a SimpleSession object.

        Args:
          session: netsnmp.Session, the SNMP session to use for queries.
        """
        self._session = session

    def get(self, oid):
        """Reads the value at the given OID.

        If an error occurs such that the get could not be completed, an empty
        list is returned.

        Returns:
          list of SNMPVariable, the results of the get request.

        Raises:
          SNMPError: netsnmp session reports any error, or no result from get.
        """
        oids = netsnmp.VarList(netsnmp.Varbind(oid))
        self._session.get(oids)
        self._check_errorstr()
        return _convert_result(oid, oids)

    def walk(self, oid):
        """Reads all values in the MIB tree starting at the given OID.

        If an error occurs such that the walk could not be completed, an empty
        list is returned.

        Returns:
          list of SNMPVariable, the results of the walk request.

        Raises:
          SNMPError: netsnmp session reports any error, or no results from walk.
        """
        oids = netsnmp.VarList(netsnmp.Varbind(oid))
        self._session.walk(oids)
        self._check_errorstr()
        return _convert_result(oid, oids)

    def _check_errorstr(self):
        """Raises an exception if the session ErrorStr attribute is set."""
        if self._session.ErrorStr:
            raise SNMPError('netsnmp error; %s: %s' % (self._session.ErrorStr,
                                                       self._session.ErrorInd))


class FakeSession(object):
    """Implements a fake SimpleSession interface for tests."""

    def __init__(self):
        self._mib = collections.defaultdict(list)

    def prepare(self, oid, tag, value):
        """Associates an OID with a tag,value for later calls to get or walk."""
        self._mib[oid].append(SNMPVariable(tag, value))

    def get(self, oid):
        return self._find_oid(oid)

    def walk(self, oid):
        return self._find_oid(oid)

    def _find_oid(self, oid):
        result = self._mib[oid]
        if not result:
            raise SNMPError('Empty result set.')
        return result


def _varlist_to_list(varlist):
    """Converts a netsnmp.Varlist to a list of SNMPVariable."""
    # The oid.val attribute starts as None and is set after a successful
    # request. If it is still None, then the request failed and it should
    # be excluded from the return value.
    result = []
    for oid in varlist:
        if oid.val is not None:
            tag = oid.tag + ('.' + oid.iid if oid.iid else '')
            result.append(SNMPVariable(tag, oid.val))
    return result


def _convert_result(original_oid, varlist):
    """Converts a netsnmp.Varlist to a list of SNMPVariable.

    Args:
        original_oid: str, the original OID requested.
        varlist: netsnmp.VarList, a container filled with netsnmp.Varbind
            objects.

    Returns:
        list of SNMPVariable, each netsnmp.Varbind element from varlist
            converted to an SNMPVariable.

    Raises:
        SNMPError: after conversion, the result was an empty set.
    """
    result = _varlist_to_list(varlist)
    if not result:
        raise SNMPError('netsnmp error unknown; OID may be invalid: ' +
                        original_oid)
    return result
