"""A simple session interface."""

import collections
import netsnmp


class SimpleSession(object):
    """A simpler session interface for netsnmp.Session."""

    def __init__(self, session):
        """Creates a SimpleSession object.

        Args:
          session: netsnmp.Session, the SNMP session to use for queries.
        """
        self._session = session

    def get(self, oid):
        """Reads the value at the given OID.

        If an error occurs such that the get could not be completed, an empty
        list is returned.

        Returns:
          list of dict, with each dict containing a 'tag' and 'val' keys.
        """
        oids = netsnmp.VarList(netsnmp.Varbind(oid))
        self._session.get(oids)
        return self._varlist_to_list(oids)

    def walk(self, oid):
        """Reads all values in the MIB tree starting at the given OID.

        If an error occurs such that the walk could not be completed, an empty
        list is returned.

        Returns:
          list of dict, with each dict containing a 'tag' and 'val' keys.
        """
        oids = netsnmp.VarList(netsnmp.Varbind(oid))
        self._session.walk(oids)
        return self._varlist_to_list(oids)

    def _varlist_to_list(self, oids):
        """Converts a netsnmp.Varlist to a list of dict."""
        # The oid.val attribute starts as None and is set after a successful
        # request. If it is still None, then the request failed and it should
        # be excluded from the return value.
        return [{'tag': oid.tag,
                 'val': oid.val} for oid in oids if oid.val is not None]


class FakeSession(object):
    """Implements a fake SimpleSession interface for tests."""

    def __init__(self):
        self._mibs = collections.defaultdict(list)

    def prepare(self, oid, key, val):
        """Associates an OID with a key,value for later calls to get or walk."""
        self._mibs[oid].append({'tag': key, 'val': val})

    def get(self, mib):
        return self._mibs.get(mib, [])

    def walk(self, mib):
        return self._mibs.get(mib, [])
