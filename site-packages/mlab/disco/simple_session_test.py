"""Tests for simple_session."""

import netsnmp
import unittest

# Third-party modules.
import mock

# Module under test.
import simple_session


class FakeVarbind(object):
    """A fake netsnmp.Varbind object."""

    def __init__(self, tag, val):
        self.tag = tag
        self.val = val


@mock.patch.object(netsnmp, 'Varbind')
@mock.patch.object(netsnmp, 'VarList')
class SimpleSessionTest(unittest.TestCase):

    def setUp(self):
        self.var = FakeVarbind('sysDescr.0', 'Fake system description.')
        self.mock_session = mock.Mock(spec=netsnmp.Session)
        self.session = simple_session.SimpleSession(self.mock_session)

    def test_get(self, mock_varlist, mock_varbind):
        mock_varlist.return_value = [self.var]

        actual = self.session.get('sysDescr.0')

        self.assertItemsEqual(
            [{'tag': 'sysDescr.0',
              'val': self.var.val}], actual)
        self.mock_session.get.assert_called_once_with(mock_varlist.return_value)
        mock_varbind.assert_called_with('sysDescr.0')

    def test_walk(self, mock_varlist, mock_varbind):
        mock_varlist.return_value = [self.var]

        actual = self.session.walk('sysDescr.0')

        self.assertItemsEqual(
            [{'tag': 'sysDescr.0',
              'val': self.var.val}], actual)
        self.mock_session.walk.assert_called_once_with(
            mock_varlist.return_value)
        mock_varbind.assert_called_with('sysDescr.0')


class FakeSessionTest(unittest.TestCase):
    """Tests for the simple_session.FakeSession class."""

    def setUp(self):
        self.session = simple_session.FakeSession()
        self.session.prepare('sysDescr.0', 'sysDescr.0',
                             'Fake system description.')

    def test_get(self):
        actual = self.session.get('sysDescr.0')

        self.assertItemsEqual(
            [{'tag': 'sysDescr.0',
              'val': 'Fake system description.'}], actual)

    def test_walk(self):
        actual = self.session.walk('sysDescr.0')

        self.assertItemsEqual(
            [{'tag': 'sysDescr.0',
              'val': 'Fake system description.'}], actual)


if __name__ == '__main__':
    unittest.main()
